<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zai-2API æ§åˆ¶å°</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 10px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .active { background-color: #28a745; }
        .inactive { background-color: #dc3545; }
        .api-box { background: #2d3436; color: #fff; padding: 10px; border-radius: 5px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container py-4">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-primary">âš¡ Zai-2API æ§åˆ¶å°</h2>
            <span class="badge bg-dark">v2.0</span>
        </header>

        <div class="row g-4">
            <!-- å·¦ä¾§ -->
            <div class="col-lg-4">
                <!-- API é…ç½® -->
                <div class="card p-3 mb-3 border-primary border-2">
                    <h5 class="card-title fw-bold text-primary">ğŸš€ API é…ç½®</h5>
                    <div class="mb-2">
                        <label class="small text-muted">Base URL:</label>
                        <div class="api-box">{{ api_url }}</div>
                    </div>
                    <div class="mb-2">
                        <label class="small text-muted">API Key:</label>
                        <div class="api-box">1 (æˆ– .env ä¸­é…ç½®çš„å¯†é’¥)</div>
                    </div>
                </div>

                <!-- æ·»åŠ è´¦å· -->
                <div class="card p-3">
                    <h5 class="card-title mb-3">â• æ·»åŠ è´¦å·</h5>
                    
                    <div class="alert alert-info">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong>ç‚¹å‡»æŒ‰é’®åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨çª—å£ã€‚<br>
                        åœ¨æµè§ˆå™¨ä¸­ç™»å½•åï¼Œè´¦å·å°†è‡ªåŠ¨ä¿å­˜ã€‚
                    </div>
                    
                    <div class="d-grid">
                        <button class="btn btn-primary btn-lg" id="loginBtn">
                            ğŸŒ å¯åŠ¨æµè§ˆå™¨ç™»å½•
                        </button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ -->
            <div class="col-lg-8">
                <!-- è´¦å·åˆ—è¡¨ -->
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between mb-3">
                        <h5 class="card-title">ğŸ‘¥ è´¦å·æ±  ({{ accounts|length }})</h5>
                        <div>
                            <span class="badge bg-success me-1">âœ… {{ active_count or 0 }}</span>
                            <span class="badge bg-danger">âŒ {{ inactive_count or 0 }}</span>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>å¥åº·çŠ¶æ€</th>
                                    <th>è´¦å·åç§°</th>
                                    <th>æ¥æº</th>
                                    <th>æ•°æ®ç›®å½•</th>
                                    <th>TokençŠ¶æ€</th>
                                    <th>è¿‡æœŸæ—¶é—´</th>
                                    <th>è°ƒç”¨æ¬¡æ•°</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for acc in accounts %}
                                <tr>
                                    <td>
                                        {% if acc.is_active %}
                                            {% if acc.token and acc.token|length > 50 %}
                                                <span class="badge bg-success">âœ… æ­£å¸¸</span>
                                            {% else %}
                                                <span class="badge bg-warning">âš ï¸ Tokenå¼‚å¸¸</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">â¸ï¸ å·²ç¦ç”¨</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ acc.name }}</strong>
                                        {% if acc.discord_username %}
                                        <br><small class="text-muted">{{ acc.discord_username }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if acc.token_source == 'browser' %}
                                        <span class="badge bg-info">ğŸŒ æµè§ˆå™¨</span>
                                        {% else %}
                                        <span class="badge bg-secondary">âœ‹ æ‰‹åŠ¨</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if acc.data_dir %}
                                        <code class="small">{{ acc.data_dir }}</code>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if acc.token %}
                                        <code class="small">{{ acc.token[:15] }}...</code>
                                        {% else %}
                                        <span class="text-danger">æ— Token</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if acc.expires_at %}
                                        <small>{{ acc.expires_at[:16].replace('T', ' ') }}</small>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-light text-dark">{{ acc.total_calls }}</span></td>
                                    <td>
                                        {% if acc.token_source == 'browser' %}
                                        <button class="btn btn-sm btn-primary me-1" onclick="refreshToken({{ acc.id }})" title="åˆ·æ–°Token">ğŸ”„</button>
                                        {% endif %}
                                        <a href="/api/account/toggle/{{ acc.id }}" class="btn btn-sm btn-outline-secondary me-1" title="å¯ç”¨/ç¦ç”¨">{% if acc.is_active %}â¸{% else %}â–¶{% endif %}</a>
                                        <a href="/api/account/delete/{{ acc.id }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('ç¡®å®šåˆ é™¤è´¦å· {{ acc.name }} å—ï¼Ÿ')" title="åˆ é™¤">ğŸ—‘</a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="8" class="text-center text-muted py-4">æš‚æ— è´¦å·ï¼Œè¯·ç‚¹å‡»å·¦ä¾§"å¯åŠ¨æµè§ˆå™¨ç™»å½•"æ·»åŠ </td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- æ—¥å¿— -->
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between mb-3">
                        <h5 class="card-title">ğŸ“Š æœ€è¿‘è°ƒç”¨æ—¥å¿—</h5>
                        <a href="/api/logs/clear" class="btn btn-sm btn-light">æ¸…ç©º</a>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead><tr><th>æ—¶é—´</th><th>è´¦å·</th><th>æ¨¡å‹</th><th>è€—æ—¶</th><th>çŠ¶æ€</th></tr></thead>
                            <tbody>
                                {% for log in logs %}
                                <tr>
                                    <td>{{ log.timestamp.split(' ')[1] if ' ' in log.timestamp else log.timestamp }}</td>
                                    <td>{{ log.account_name }}</td>
                                    <td>{{ log.model }}</td>
                                    <td>{{ log.duration }}ms</td>
                                    <td>
                                        {% if log.status == 'SUCCESS' %}
                                        <span class="badge bg-success">æˆåŠŸ</span>
                                        {% else %}
                                        <span class="badge bg-danger">å¤±è´¥</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- TokençŠ¶æ€æ£€æŸ¥ -->
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">ğŸ” TokençŠ¶æ€æ£€æŸ¥</h5>
                        <button class="btn btn-sm btn-info" onclick="checkTokenStatus()">æ£€æŸ¥çŠ¶æ€</button>
                    </div>
                    <div id="tokenStatus" class="small text-muted">ç‚¹å‡»æ£€æŸ¥æ‰€æœ‰è´¦å·TokençŠ¶æ€</div>
                </div>

                <!-- æœåŠ¡æ§åˆ¶ -->
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">âš™ï¸ æœåŠ¡æ§åˆ¶</h5>
                        <div>
                            <button class="btn btn-sm btn-warning me-1" onclick="restartService()">ğŸ”„ é‡å¯æœåŠ¡</button>
                            <button class="btn btn-sm btn-danger" onclick="stopService()">ğŸ›‘ åœæ­¢æœåŠ¡</button>
                        </div>
                    </div>
                    <div class="small text-muted">
                        é‡å¯æˆ–åœæ­¢æ•´ä¸ªZai-2APIæœåŠ¡ã€‚åœæ­¢åéœ€è¦æ‰‹åŠ¨é‡æ–°å¯åŠ¨ç¨‹åºã€‚
                    </div>
                </div>

                <!-- è‡ªåŠ¨åˆ·æ–°ç®¡ç† -->
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">ğŸ”„ è‡ªåŠ¨åˆ·æ–°ç®¡ç†</h5>
                        <div>
                            <button class="btn btn-sm btn-success me-1" onclick="startAutoRefresh()">å¯åŠ¨</button>
                            <button class="btn btn-sm btn-warning me-1" onclick="stopAutoRefresh()">åœæ­¢</button>
                            <button class="btn btn-sm btn-danger me-1" onclick="forceRefreshAll()">å¼ºåˆ¶åˆ·æ–°</button>
                            <button class="btn btn-sm btn-info" id="previewModeBtn" onclick="togglePreviewMode()">ğŸ‘ï¸ å¼€å¯é¢„è§ˆ</button>
                        </div>
                    </div>
                    <div id="refreshStatus" class="small">
                        <div class="d-flex align-items-center">
                            <span id="refreshIndicator" class="me-2 text-success">ğŸŸ¢</span>
                            <span id="refreshText" class="text-success">è‡ªåŠ¨åˆ·æ–°æœåŠ¡è¿è¡Œä¸­ï¼ˆæ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼‰</span>
                        </div>
                    </div>
                    <div id="previewModeIndicator" class="small text-muted mt-2">
                        <span class="text-muted">é¢„è§ˆæ¨¡å¼å·²å…³é—­ï¼ˆåˆ·æ–°Tokenæ—¶å°†åœ¨åå°é™é»˜è¿è¡Œï¼‰</span>
                    </div>
                </div>

                <!-- å‡­æ®åº“ç®¡ç† -->
                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">ğŸ” ç™»å½•å‡­æ®ç®¡ç†</h5>
                        <button class="btn btn-sm btn-primary" onclick="showCredentialsModal()">ç®¡ç†å‡­æ®</button>
                    </div>
                    <div class="small text-muted">æ·»åŠ è´¦å·çš„ç™»å½•å‡­æ®ä»¥æ”¯æŒè‡ªåŠ¨åˆ·æ–°</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æµè§ˆå™¨ç™»å½•
        document.getElementById('loginBtn').addEventListener('click', async function() {
            var name = prompt("è¯·è¾“å…¥è´¦å·åç§°:", "æˆ‘çš„è´¦å·");
            if (!name) return;
            
            var btn = this;
            var originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = 'â³ å¯åŠ¨ä¸­...';
            btn.className = 'btn btn-warning btn-lg';
            
            try {
                var formData = new FormData();
                formData.append('name', name);
                
                var res = await fetch('/api/account/login/start', {
                    method: 'POST',
                    body: formData
                });
                
                var data = await res.json();
                
                if (data.success) {
                    alert("âœ… " + data.message);
                    window.location.reload();
                } else {
                    alert("âŒ " + data.message);
                }
            } catch (e) {
                alert("âŒ é”™è¯¯: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.className = 'btn btn-primary btn-lg';
            }
        });
        
        // åˆ·æ–°Token
        async function refreshToken(accountId) {
            if (!confirm('ç¡®å®šè¦åˆ·æ–°æ­¤è´¦å·çš„Tokenå—ï¼Ÿ')) return;
            
            try {
                var res = await fetch('/api/token/refresh/' + accountId, {
                    method: 'POST'
                });
                var data = await res.json();
                
                if (data.success) {
                    alert('âœ… åˆ·æ–°æˆåŠŸ');
                    window.location.reload();
                } else {
                    alert('âŒ åˆ·æ–°å¤±è´¥');
                }
            } catch (e) {
                alert('âŒ é”™è¯¯: ' + e.message);
            }
        }
        
        // TokençŠ¶æ€æ£€æŸ¥ï¼ˆå¦‚æœé¡µé¢ä¸Šæœ‰è¿™ä¸ªæŒ‰é’®ï¼‰
        async function checkTokenStatus() {
            alert('æ­¤åŠŸèƒ½æš‚æœªå®ç°');
        }
        
        // è‡ªåŠ¨åˆ·æ–°æ§åˆ¶ï¼ˆå¦‚æœé¡µé¢ä¸Šæœ‰è¿™äº›æŒ‰é’®ï¼‰
        async function startAutoRefresh() {
            alert('è‡ªåŠ¨åˆ·æ–°æœåŠ¡å·²åœ¨åå°è¿è¡Œ');
        }
        
        async function stopAutoRefresh() {
            alert('æ­¤åŠŸèƒ½æš‚æœªå®ç°');
        }
        
        async function forceRefreshAll() {
            if (!confirm('ç¡®å®šè¦å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰æµè§ˆå™¨è´¦å·å—ï¼Ÿ')) return;
            alert('æ­¤åŠŸèƒ½æš‚æœªå®ç°');
        }
        
        // é¢„è§ˆæ¨¡å¼åˆ‡æ¢
        var previewModeEnabled = false;
        function togglePreviewMode() {
            previewModeEnabled = !previewModeEnabled;
            var btn = document.getElementById('previewModeBtn');
            var indicator = document.getElementById('previewModeIndicator');
            
            if (previewModeEnabled) {
                btn.innerHTML = 'ğŸ‘ï¸ å…³é—­é¢„è§ˆ';
                btn.className = 'btn btn-sm btn-warning';
                indicator.innerHTML = '<span class="text-warning">ğŸ‘ï¸ é¢„è§ˆæ¨¡å¼å·²å¼€å¯ï¼ˆåˆ·æ–°Tokenæ—¶å°†æ˜¾ç¤ºæµè§ˆå™¨çª—å£ï¼‰</span>';
            } else {
                btn.innerHTML = 'ğŸ‘ï¸ å¼€å¯é¢„è§ˆ';
                btn.className = 'btn btn-sm btn-info';
                indicator.innerHTML = '<span class="text-muted">é¢„è§ˆæ¨¡å¼å·²å…³é—­ï¼ˆåˆ·æ–°Tokenæ—¶å°†åœ¨åå°é™é»˜è¿è¡Œï¼‰</span>';
            }
            
            // å‘é€åˆ°åç«¯
            fetch('/api/settings/preview-mode', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enabled: previewModeEnabled})
            });
        }
        
        // å‡­æ®ç®¡ç†
        function showCredentialsModal() {
            alert('ğŸ’¡ å‡­æ®ç®¡ç†æç¤º\n\n' +
                  'å½“å‰ç³»ç»Ÿä½¿ç”¨"æµè§ˆå™¨ç™»å½•"æ–¹å¼ï¼Œç™»å½•çŠ¶æ€å·²è‡ªåŠ¨ä¿å­˜ã€‚\n\n' +
                  'âœ… ä¼˜ç‚¹ï¼š\n' +
                  'â€¢ æ— éœ€æ‰‹åŠ¨ç®¡ç†å¯†ç \n' +
                  'â€¢ æµè§ˆå™¨è‡ªåŠ¨è®°ä½ç™»å½•çŠ¶æ€\n' +
                  'â€¢ Tokenä¼šè‡ªåŠ¨åˆ·æ–°\n\n' +
                  'å¦‚éœ€æ·»åŠ æ–°è´¦å·ï¼Œè¯·ç‚¹å‡»"å¯åŠ¨æµè§ˆå™¨ç™»å½•"');
        }
        
        // æœåŠ¡æ§åˆ¶
        async function restartService() {
            if (!confirm('âš ï¸ ç¡®å®šè¦é‡å¯æœåŠ¡å—ï¼Ÿ\n\næœåŠ¡å°†åœ¨3ç§’åé‡å¯ï¼ŒæœŸé—´æ‰€æœ‰APIè°ƒç”¨ä¼šä¸­æ–­ã€‚')) return;
            
            alert('ğŸ”„ æœåŠ¡é‡å¯åŠŸèƒ½éœ€è¦é…åˆè¿›ç¨‹ç®¡ç†å·¥å…·ï¼ˆå¦‚PM2ã€Supervisorï¼‰\n\nå½“å‰è¯·æ‰‹åŠ¨æ“ä½œï¼š\n1. åœ¨å‘½ä»¤è¡ŒæŒ‰ Ctrl+C åœæ­¢\n2. é‡æ–°è¿è¡Œ start.bat');
        }
        
        async function stopService() {
            if (!confirm('âš ï¸ ç¡®å®šè¦åœæ­¢æœåŠ¡å—ï¼Ÿ\n\nåœæ­¢åéœ€è¦æ‰‹åŠ¨è¿è¡Œ start.bat é‡æ–°å¯åŠ¨ã€‚')) return;
            
            try {
                var res = await fetch('/api/service/stop', {method: 'POST'});
                var data = await res.json();
                
                if (data.success) {
                    alert('ğŸ›‘ ' + data.message);
                    document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;flex-direction:column;"><h1 style="color:#dc3545;">ğŸ›‘ æœåŠ¡å·²åœæ­¢</h1><p>è¯·è¿è¡Œ start.bat é‡æ–°å¯åŠ¨æœåŠ¡</p></div>';
                }
            } catch (e) {
                alert('æœåŠ¡å¯èƒ½å·²åœæ­¢');
            }
        }
    </script>
</body>
</html>
