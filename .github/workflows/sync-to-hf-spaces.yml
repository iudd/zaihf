name: Sync to HF Spaces (100% Stable Final)
on:
  push:
    branches: [main]
  workflow_dispatch:
jobs:
  sync-to-hf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install huggingface_hub
        run: pip install huggingface_hub
      - name: Upload all files via HF API (Batch Mode)
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python - <<EOF
          from huggingface_hub import HfApi, CommitOperationAdd
          import os
          # 1. 初始化 API
          api = HfApi(token=os.environ["HF_TOKEN"])
          space_id = "iyougame/zaihf"
          commit_message = f"Sync from GitHub: ${{ github.sha }}"
          # 2. 收集所有要上传的操作对象
          operations = []
          
          print(f"正在扫描文件...")
          for root, dirs, files in os.walk("."):
              # 跳过无关目录
              if ".git" in root or ".github" in root or "hf_sync_temp" in root:
                  continue
              
              for file in files:
                  local_path = os.path.join(root, file)
                  # 获取相对路径作为仓库内的路径
                  repo_path = os.path.relpath(local_path, ".")
                  
                  # 创建 CommitOperationAdd 对象并加入列表
                  operations.append(
                      CommitOperationAdd(path_in_repo=repo_path, path_or_fileobj=local_path)
                  )
          
          print(f"扫描完成，准备上传 {len(operations)} 个文件...")
          # 3. 批量上传并提交
          if operations:
              try:
                  # 修复点：删除了不支持的 delete_file_patterns 参数
                  api.create_commit(
                      repo_id=space_id,
                      repo_type="space",
                      commit_message=commit_message,
                      operations=operations,
                  )
                  print("✅ 文件上传成功！")
              except Exception as e:
                  print(f"❌ 上传失败: {e}")
                  exit(1)
          else:
              print("⚠️ 没有发现需要上传的文件。")
          # 4. 重启 Spaces
          try:
              api.restart_space(repo_id=space_id)
              print("✅ Spaces 重启指令已发送！")
          except Exception as e:
              print(f"⚠️ 文件已同步，但重启 Spaces 失败（通常不影响运行）: {e}")
          EOF